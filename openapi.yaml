openapi: 3.0.0

info:
  title: Public API
  version: 2.0.1
  description: MasterDelivery Public API

servers:
  - url: https://backend.md-dev.ru
    description: dev-server

security:
  - bearerAuth: []

tags:
  - name: orders
    description: Операции по заказам

  - name: places
    description: Операции с торговыми точками

  - name: places/block
    description: Блокировки торговых точек

  - name: places/areas
    description: Зоны доставки торговых точек

  - name: places/schedule
    description: Расписание работы торговых точек

  - name: merchant/schedule
    description: Расписание работы мерчанта

paths:
  /public/v2/orders/:
    post:
      tags: [orders]
      summary: Public:Create Order
      description: Создание заказа.
      operationId: public_create_order_public_v2_orders_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderDetailForResponse"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v2/orders/dry_run/:
    post:
      tags: [orders]
      summary: Public:Dry Run
      description: "Проверка: возможно ли создать заказ."
      operationId: public_dry_run_public_v2_orders_dry_run_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderDryRun"
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BaseSchemaResponse"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v2/orders/{order_id}/:
    get:
      tags: [orders]
      summary: Public:Get Order
      description: Получить данные заказа.
      operationId: public_get_order_public_v2_orders_order_id_get
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            anyOf:
              - type: string
                format: uuid
              - type: string
        - in: query
          name: is_external_id
          required: false
          schema:
            type: boolean
            default: false
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderDetailedForResponse"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

    delete:
      tags: [orders]
      summary: Public:Cancel Order
      description: Отмена заказа.
      operationId: public_cancel_order_public_v2_orders_order_id_delete
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            anyOf:
              - type: string
                format: uuid
              - type: string
        - in: query
          name: is_external_id
          required: false
          schema:
            type: boolean
            default: false
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CancelOrderInRequest"
      responses:
        "200":
          description: Successful Response
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

    patch:
      tags: [orders]
      summary: Public:Update Order
      description: Обновление данных заказа.
      operationId: public_update_order_public_v2_orders_order_id_patch
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            anyOf:
              - type: string
                format: uuid
              - type: string
        - in: query
          name: is_external_id
          required: false
          schema:
            type: boolean
            default: false
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateOrderInRequest"
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderDetailForResponse"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v2/orders/{order_id}/return/:
    patch:
      tags: [orders]
      summary: Public:Return Order
      description: Возврат продуктов заказа.
      operationId: public_return_order_public_v2_orders_order_id_return_patch
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            anyOf:
              - type: string
                format: uuid
              - type: string
        - in: query
          name: is_external_id
          required: false
          schema:
            type: boolean
            default: false
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReturnProductsInRequest"
      responses:
        "200":
          description: Successful Response

  /public/v2/orders/{order_id}/tracking/:
    get:
      tags: [orders]
      summary: Public:Get Courier Position
      operationId: public_get_courier_position_public_v2_orders_order_id_tracking_get
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            anyOf:
              - type: string
                format: uuid
              - type: string
        - in: query
          name: is_external_id
          required: false
          schema:
            type: boolean
            default: false
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicCourierPositionForResponse"

  /public/v2/orders/{order_id}/state/:
    post:
      tags: [orders]
      summary: Public:Create Merchant Order State
      description: >
        Принимает данные о статусе заказа от партнера и сохраняет их в БД
        для последующей обработки.
      operationId: public_create_merchant_order_state_public_v2_orders_order_id_state_post
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            anyOf:
              - type: string
                format: uuid
              - type: string
        - in: query
          name: is_external_id
          required: false
          schema:
            type: boolean
            default: false
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MerchantOrderStateInRequest"
      responses:
        "200":
          description: Successful Response

  /public/v2/orders/route/:
    post:
      tags: [orders]
      summary: Public:Create Batch Order
      description: Создание группового заказа.
      operationId: public_create_batch_order_public_v2_orders_route_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateGroupOrderInRequest"
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GroupOrderDetailForResponse"

  /public/v2/orders/route/{group_id}/:
    get:
      tags: [orders]
      summary: Public:Get Batch Order
      description: Получить данные группового заказа.
      operationId: public_get_batch_order_public_v2_orders_route_group_id_get
      parameters:
        - in: path
          name: group_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GroupOrderDetailedForResponse"

    delete:
      tags: [orders]
      summary: Public:Cancel Batch Order
      description: Отмена группового заказа.
      operationId: public_cancel_batch_order_public_v2_orders_route_group_id_delete
      parameters:
        - in: path
          name: group_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CancelOrderInRequest"
      responses:
        "204":
          description: Successful Response

  /public/v1/merchant/places/order-check/:
    post:
      tags: [orders]
      summary: Places:Order Check
      description: >
        Проверка возможности создания заказа на ТТ и определение времени,
        требуемого на доставку.
      operationId: places_order_check_public_v1_merchant_places_order_check_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderCheckInRequest"
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlaceAccessList"

  /public/v1/merchant/places:
    get:
      tags: [places]
      summary: Places:Get Places
      description: Получить список торговых точек.
      operationId: public_get_places_public_v1_merchant_places_get
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PlaceInDB"

    post:
      tags: [places]
      summary: Places:Create Place
      description: Создать торговую точку.
      operationId: public_create_place_public_v1_merchant_places_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlaceInDB"

  /public/v1/merchant/places/{place_id}:
    get:
      tags: [places]
      summary: Places:Get Place
      description: Получить данные торговой точки.
      operationId: public_get_place_public_v1_merchant_places_place_id_get
      parameters:
        - in: path
          name: place_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlaceInDB"

    put:
      tags: [places]
      summary: Places:Update Place
      description: Обновить данные торговой точки.
      operationId: public_update_place_public_v1_merchant_places_place_id_put
      parameters:
        - in: path
          name: place_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlaceInDB"

  /public/v1/merchant/places/block/:
    post:
      tags: [places/block]
      summary: Places:Block Places
      description: Заблокировать одну или несколько торговых точек.
      operationId: public_block_places_public_v1_merchant_places_block_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MerchantPlaceBlockInRequest"
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PlaceBlockInResponse"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v1/merchant/places/unblock/:
    post:
      tags: [places/block]
      summary: Places:Unblock Places
      description: Разблокировать одну или несколько торговых точек.
      operationId: public_unblock_places_public_v1_merchant_places_unblock_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                place_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                merchant_place_ids:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PlaceBlockInResponse"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v1/merchant/places/blocks/:
    get:
      tags: [places/block]
      summary: Places:Get Blocks
      description: Получить список блокировок торговых точек.
      operationId: public_get_blocks_public_v1_merchant_places_blocks_get
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
        - in: query
          name: place_id
          required: false
          schema:
            type: string
            format: uuid
        - in: query
          name: merchant_place_id
          required: false
          schema:
            type: string
        - in: query
          name: is_active
          required: false
          schema:
            type: boolean
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/BlockInResponse"

  /public/v1/merchant/places/areas/:
    post:
      tags: [places/areas]
      summary: Places:Create Areas
      description: Создать зоны доставки для торговых точек.
      operationId: public_create_areas_public_v1_merchant_places_areas_post
      parameters:
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AreaCreatePublic"
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AreaInResponsePublic"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v1/merchant/places/{merchant_place_id}/area/:
    get:
      tags: [places/areas]
      summary: Places:Get Area
      description: Получить зоны доставки для конкретной торговой точки.
      operationId: public_get_area_public_v1_merchant_places_merchant_place_id_area_get
      parameters:
        - in: path
          name: merchant_place_id
          required: true
          schema:
            type: string
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AreaInResponsePublic"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

  /public/v1/merchant/places/{place_id}/schedule:
    get:
      tags: [places/schedule]
      summary: Places:Get Schedule
      description: Получить расписание работы торговой точки.
      operationId: public_get_place_schedule_public_v1_merchant_places_place_id_schedule_get
      parameters:
        - in: path
          name: place_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkTimes"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

    put:
      tags: [places/schedule]
      summary: Places:Update Schedule
      description: Обновить расписание работы торговой точки.
      operationId: public_update_place_schedule_public_v1_merchant_places_place_id_schedule_put
      parameters:
        - in: path
          name: place_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkTimesUpdate"
      responses:
        "200":
          description: Successful Response

  /public/v1/merchant/{merchant_id}/schedule:
    get:
      tags: [merchant/schedule]
      summary: Merchant:Get Schedule
      description: Получить расписание работы мерчанта.
      operationId: public_get_merchant_schedule_public_v1_merchant_merchant_id_schedule_get
      parameters:
        - in: path
          name: merchant_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkTimes"
        "422":
          description: Validation Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"

    put:
      tags: [merchant/schedule]
      summary: Merchant:Update Schedule
      description: Обновить расписание работы мерчанта.
      operationId: public_update_merchant_schedule_public_v1_merchant_merchant_id_schedule_put
      parameters:
        - in: path
          name: merchant_id
          required: true
          schema:
            type: string
            format: uuid
        - in: header
          name: authorization
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkTimesUpdate"
      responses:
        "200":
          description: Successful Response

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    HTTPValidationError:
      type: object
      properties:
        detail:
          type: array
          items:
            $ref: "#/components/schemas/ValidationError"

    ValidationError:
      type: object
      properties:
        loc:
          type: array
          items:
            type: string
        msg:
          type: string
        type:
          type: string

    # -------------------------
    # ORDER SCHEMAS
    # -------------------------

    OrderDetailForResponse:
      type: object
      properties:
        order_id:
          type: string
        external_id:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        price:
          type: number
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"

    OrderItem:
      type: object
      properties:
        product_id:
          type: string
        name:
          type: string
        quantity:
          type: number
        price:
          type: number

    OrderDetailedForResponse:
      allOf:
        - $ref: "#/components/schemas/OrderDetailForResponse"
        - type: object
          properties:
            courier:
              $ref: "#/components/schemas/CourierInfo"
            delivery_eta:
              type: string

    CourierInfo:
      type: object
      properties:
        courier_id:
          type: string
        name:
          type: string
        phone:
          type: string
        position:
          $ref: "#/components/schemas/CourierPosition"

    CourierPosition:
      type: object
      properties:
        lat:
          type: number
        lon:
          type: number
        timestamp:
          type: string
          format: date-time

    PublicCourierPositionForResponse:
      type: object
      properties:
        position:
          $ref: "#/components/schemas/CourierPosition"

    OrderDryRun:
      type: object
      properties:
        place_id:
          type: string
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"
        address:
          type: string

    BaseSchemaResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    CancelOrderInRequest:
      type: object
      properties:
        reason:
          type: string

    UpdateOrderInRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"
        comment:
          type: string

    ReturnProductsInRequest:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              product_id:
                type: string
              quantity:
                type: number

    MerchantOrderStateInRequest:
      type: object
      properties:
        state:
          type: string
        comment:
          type: string

    CreateGroupOrderInRequest:
      type: object
      properties:
        orders:
          type: array
          items:
            type: string
        route_type:
          type: string

    GroupOrderDetailForResponse:
      type: object
      properties:
        group_id:
          type: string
        orders:
          type: array
          items:
            $ref: "#/components/schemas/OrderDetailForResponse"

    GroupOrderDetailedForResponse:
      type: object
      properties:
        group_id:
          type: string
        orders:
          type: array
          items:
            $ref: "#/components/schemas/OrderDetailedForResponse"

    OrderCheckInRequest:
      type: object
      properties:
        place_id:
          type: string
        address:
          type: string
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"

    PlaceAccessList:
      type: object
      properties:
        available:
          type: boolean
        delivery_time_minutes:
          type: integer

    # -------------------------
    # PLACES SCHEMAS
    # -------------------------

    PlaceInDB:
      type: object
      properties:
        place_id:
          type: string
        merchant_id:
          type: string
        name:
          type: string
        address:
          type: string
        is_active:
          type: boolean

    # -------------------------
    # BLOCK SCHEMAS
    # -------------------------

    MerchantPlaceBlockInRequest:
      type: object
      properties:
        place_ids:
          type: array
          items:
            type: string
        merchant_place_ids:
          type: array
          items:
            type: string
        reason:
          type: string

    PlaceBlockInResponse:
      type: object
      properties:
        place_id:
          type: string
        merchant_place_id:
          type: string
        is_active:
          type: boolean
        reason:
          type: string
        created_at:
          type: string
          format: date-time

    BlockInResponse:
      type: object
      properties:
        block_id:
          type: string
        place_id:
          type: string
        merchant_place_id:
          type: string
        is_active:
          type: boolean
        reason:
          type: string
        created_at:
          type: string
          format: date-time

    # -------------------------
    # AREAS SCHEMAS
    # -------------------------

    AreaCreatePublic:
      type: object
      properties:
        merchant_place_id:
          type: string
        polygons:
          type: array
          items:
            $ref: "#/components/schemas/Polygon"

    Polygon:
      type: object
      properties:
        points:
          type: array
          items:
            $ref: "#/components/schemas/GeoPoint"

    GeoPoint:
      type: object
      properties:
        lat:
          type: number
        lon:
          type: number

    AreaInResponsePublic:
      type: object
      properties:
        merchant_place_id:
          type: string
        polygons:
          type: array
          items:
            $ref: "#/components/schemas/Polygon"

    # -------------------------
    # SCHEDULE SCHEMAS
    # -------------------------

    WorkTimes:
      type: object
      properties:
        days:
          type: array
          items:
            $ref: "#/components/schemas/WorkDay"

    WorkDay:
      type: object
      properties:
        day:
          type: string
        intervals:
          type: array
          items:
            $ref: "#/components/schemas/WorkInterval"

    WorkInterval:
      type: object
      properties:
        start:
          type: string
        end:
          type: string

    WorkTimesUpdate:
      type: object
      properties:
        days:
          type: array
          items:
            $ref: "#/components/schemas/WorkDay"
